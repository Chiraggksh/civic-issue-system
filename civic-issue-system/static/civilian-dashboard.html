<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Civilian Dashboard - Civic Issue Reporting</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body { background-color: #f4f6f9; font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif; }
    .navbar { background-color: #003366; }
    .navbar-brand, .nav-link, .navbar-text { color: #fff !important; }
    .card { border-radius: 10px; box-shadow: 0 2px 6px rgba(0,0,0,0.15); }
    .form-label { font-weight: 600; }
    .chart-container { background: #fff; border-radius: 10px; padding: 20px; box-shadow: 0 2px 6px rgba(0,0,0,0.15); }
  </style>
</head>
<body>
<nav class="navbar navbar-expand-lg">
  <div class="container-fluid">
    <a class="navbar-brand" href="#">Civic Issue Portal</a>
    <!-- <span class="navbar-text me-auto">Civilian Dashboard</span> -->
    <button id="logoutBtn" class="btn btn-outline-light btn-sm">Logout</button>
  </div>
</nav>

  <div class="container my-4">
    <div class="row g-4">
      <div class="col-lg-6">
        <div class="card p-4">
          <h4 class="mb-3 text-primary">Report an Issue</h4>
          <form id="reportForm" enctype="multipart/form-data">
            <div class="mb-3">
              <label class="form-label">Issue Title</label>
              <input type="text" class="form-control" id="title" name="title" required>
            </div>
            <div class="mb-3">
              <label class="form-label">Description</label>
              <textarea class="form-control" id="description" name="description" rows="3" required></textarea>
            </div>
            <div class="mb-3">
              <label class="form-label">Category</label>
              <select class="form-select" id="category" name="category" required>
                <option value="">Select Category</option>
                <option>Road</option>
                <option>Water</option>
                <option>Electricity</option>
                <option>Sanitation</option>
                <option>Other</option>
              </select>
            </div>
            <div class="mb-3">
              <label class="form-label">Constituency</label>
              <input type="text" class="form-control" id="constituency" name="constituency" placeholder="e.g. South Delhi" required>
            </div>
            <div class="mb-3">
              <label class="form-label">Location (optional)</label>
              <input type="text" class="form-control" id="location" name="location">
            </div>
            <div class="mb-3">
              <label class="form-label">Upload Photo</label>
              <input type="file" class="form-control" id="image_file" name="image_file" accept="image/*">
            </div>
            <button type="submit" class="btn btn-primary w-100">Submit Issue</button>
          </form>
          <div id="formMessage" class="mt-3"></div>
        </div>
      </div>

      <div class="col-lg-6">
        <div class="card p-4 mb-4">
          <h4 class="mb-3 text-success">Reported Issues</h4>
          <input type="text" id="searchConstituency" class="form-control mb-3" placeholder="Enter Constituency and press Enter">
          <table class="table table-striped" id="issuesTable">
            <thead>
              <tr><th>Title</th><th>Category</th><th>Constituency</th><th>Date</th></tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>

        <div class="chart-container">
          <h5 class="text-center">Issues by Category</h5>
          <canvas id="issuesChart"></canvas>
        </div>
      </div>
    </div>
  </div>

  <script>
    // === IMPORTANT: point this to your Flask backend (default port 5000) ===
    const API_BASE_URL = "http://127.0.0.1:5000";

    const form = document.getElementById("reportForm");
    const formMessage = document.getElementById("formMessage");
    const issuesTableBody = document.querySelector("#issuesTable tbody");
    const searchConstituency = document.getElementById("searchConstituency");
    const ctx = document.getElementById("issuesChart").getContext("2d");
    const logoutBtn = document.getElementById('logoutBtn');
    let chart;
    let currentConstituency = "";


    // Submit issue
    form.addEventListener("submit", async (e) => {
      e.preventDefault();
      formMessage.textContent = "";

      const formData = new FormData(form);
      // read constituency for auto-refresh after submit
      const constituencyVal = (formData.get("constituency") || "").trim();

      try {
        const response = await fetch(`${API_BASE_URL}/report_issue`, {
          method: "POST",
          body: formData
        });

        const text = await response.text(); // handle non-json gracefully
        let result;
        try { result = JSON.parse(text); } catch { result = { message: text || "No response body" }; }

        if (response.ok) {
          formMessage.innerHTML = `<div class="alert alert-success">${result.message || "Submitted"}</div>`;
          form.reset();
          // refresh results for the constituency if provided
          if (constituencyVal) fetchIssues(constituencyVal);
        } else {
          formMessage.innerHTML = `<div class="alert alert-danger">Error ${response.status}: ${result.message || text}</div>`;
        }
      } catch (err) {
        console.error("Network error:", err);
        formMessage.innerHTML = `<div class="alert alert-danger">Network error: ${err.message}</div>`;
      }
    });

    // Fetch issues for a constituency
    async function fetchIssues(constituency) {
              if (!constituency) return;
              try {
                const response = await fetch(`${API_BASE_URL}/issues/${encodeURIComponent(constituency)}`);
                const data = await response.json();

                if (!response.ok) {
                  console.error("Server error:", data);
                  return;
                }

                // Sort by upvotes descending
                data.issues.sort((a, b) => b.upvotes - a.upvotes);

                issuesTableBody.innerHTML = "";
                let categoryCount = {};

                data.issues.forEach(issue => {
                  const date = issue.created_at ? new Date(issue.created_at).toLocaleString() : "-";

                  const rowHTML = `
                    <tr>
                      <td>${escapeHtml(issue.title)}
                        <br>
                        <small>Upvotes: <span id="upvote-${issue.id}">${issue.upvotes}</span>
                        <button class="btn btn-sm btn-outline-primary ms-2" onclick="upvote('${issue.id}')">Upvote</button></small>
                      </td>
                      <td>${escapeHtml(issue.category)}</td>
                      <td>${escapeHtml(issue.constituency)}</td>
                      <td>${date}</td>
                    </tr>
                  `;

                  issuesTableBody.insertAdjacentHTML("beforeend", rowHTML);

                  categoryCount[issue.category] = (categoryCount[issue.category] || 0) + 1;
                });

                // Update chart only if there is data
                if (Object.keys(categoryCount).length > 0) {
                  updateChart(categoryCount);
                }

              } catch (err) {
                console.error("Fetch issues error:", err);
              }
            }

    async function upvote(issueId) {
        try {
          const response = await fetch(`${API_BASE_URL}/upvote/${issueId}`, { method: "POST" });
          const data = await response.json();
          if (response.ok) {
            document.getElementById(`upvote-${issueId}`).textContent = data.upvotes;
            
                 // Refresh the table and chart using current constituency
            if (currentConstituency) refreshIssues();
          } else {
            console.error("Upvote error:", data.message);
          }
        } catch (err) {
          console.error("Network error:", err);
        }
    }

    //refreshing issues 
      let fetchTimeout;
      function refreshIssues() {
        if (fetchTimeout) clearTimeout(fetchTimeout);
        fetchTimeout = setTimeout(() => {
          if (currentConstituency) fetchIssues(currentConstituency);
        }, 200); // 200ms delay
      }

    // Update chart
    function updateChart(categoryCount) {
      const labels = Object.keys(categoryCount);
      const values = Object.values(categoryCount);

      if (chart) chart.destroy();
      chart = new Chart(ctx, {
        type: "bar",
        data: {
          labels,
          datasets: [{ label: "Number of Issues", data: values, backgroundColor: labels.map(()=> "#007bff") }]
        },
        options: { responsive: true, plugins: { legend: { display: false } } }
      });
    }

    // Press Enter to search
    searchConstituency.addEventListener("keypress", (e) => {
      if (e.key === "Enter") {
          e.preventDefault(); // prevent form submit if inside a form
          currentConstituency = searchConstituency.value.trim();
          if (currentConstituency) fetchIssues(currentConstituency);
        }
    });

    //logout ki functionality
    logoutBtn.addEventListener('click', async () => {
    try {
      const response = await fetch('http://127.0.0.1:5000/logout', {
        method: 'POST',
        credentials: 'include' // only needed if you use session/cookies
      });

      const result = await response.json();
      if (response.ok) {
        alert(result.message);
        // Redirect to login page after logout
        window.location.href = 'login.html'; // replace with your login page
      } else {
        alert('Logout failed: ' + result.message);
      }
    } catch (err) {
      console.error('Logout error:', err);
      alert('Network error during logout');
    }
  });

    // small html-escape helper to avoid XSS from demo data
    function escapeHtml(s) {
      if (!s) return "";
      return s.replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]));
    }
  </script>
</body>
</html>
